{"version":3,"sources":["../../../../../../assets/scripts/node/entity/assets/scripts/node/entity/EntityMgr.js"],"names":["cc","Class","ctor","allEntityType","EntityPoint","class","require","layer","EntityFloor","EntityBorn","EntityTarget","EntityMonster","TowerSlowDown","TowerPistol","TowerMachinegun","TowerLaser","TowerGuidemissile","TowerFire","TowerBomb","BulletBomb","BulletFire","BulletGuidemissile","BulletLaser","BulletPistol","BulletBombEffect","PoolMgr","poolMgr","setBuildFunc","entityType","entityClass","entity","_entity_uuid_","bind","setDestroyFunc","isValid","unInitEntity","destroy","recycleList","undefined","entityLayerMap","aliveEntityMap","initEntityMgr","layerMap","monsterEntityNum","unInitEntityMgr","createEntity","x","y","get","error","parent","active","args","initEntity","createEntityNotInLayer","clearEntityByType","useList","getUse","key","clearEntity","push","removeFromParent","logicUpdate","dt","i","length","getMonsterNum","getNearEntity","targetEntityType","findTarget","findDis","target","isAlive","nowDis","utils","dis2"],"mappings":"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","file":"EntityMgr.js","sourceRoot":"../../../../../../assets/scripts/node/entity","sourcesContent":["cc.Class({\n    ctor(){\n        this.allEntityType = {\n            EntityPoint:{class:require(\"EntityPoint\"),layer:\"point\"},\n            EntityFloor:{class:require(\"EntityFloor\"),layer:\"floor\"},\n            EntityBorn:{class:require(\"EntityBorn\"),layer:\"born\"},\n            EntityTarget:{class:require(\"EntityTarget\"),layer:\"target\"},\n            EntityMonster:{class:require(\"EntityMonster\"),layer:\"monster\"},\n\n            TowerSlowDown:{class:require(\"TowerSlowDown\"),layer:\"tower\"},\n            TowerPistol:{class:require(\"TowerPistol\"),layer:\"tower\"},\n            TowerMachinegun:{class:require(\"TowerMachinegun\"),layer:\"tower\"},\n            TowerLaser:{class:require(\"TowerLaser\"),layer:\"laser\"},\n            TowerGuidemissile:{class:require(\"TowerGuidemissile\"),layer:\"tower\"},\n            TowerFire:{class:require(\"TowerFire\"),layer:\"fire\"},\n            TowerBomb:{class:require(\"TowerBomb\"),layer:\"tower\"},\n\n            BulletBomb:{class:require(\"BulletBomb\"),layer:\"effect\"},\n            BulletFire:{class:require(\"BulletFire\"),layer:\"effect\"},\n            BulletGuidemissile:{class:require(\"BulletGuidemissile\"),layer:\"effect\"},\n            BulletLaser:{class:require(\"BulletLaser\"),layer:\"effect\"},\n            BulletPistol:{class:require(\"BulletPistol\"),layer:\"effect\"},\n            BulletBombEffect:{class:require(\"BulletBombEffect\"),layer:\"effect\"},\n        };\n\n        var PoolMgr = require(\"PoolMgr\");\n        this.poolMgr = new PoolMgr;\n        this.poolMgr.setBuildFunc(function(entityType){\n            var entityClass = this.allEntityType[entityType].class;\n            var entity = new entityClass();\n            entity._entity_uuid_ = this._entity_uuid_;\n            this._entity_uuid_++;\n\n            entity.entityType = entityType;\n            return entity;\n        }.bind(this));\n        this.poolMgr.setDestroyFunc(function(entityType,entity){\n            if(cc.isValid(entity)){\n                entity.unInitEntity();\n                entity.destroy();\n            }\n        }.bind(this));\n\n        this.recycleList = undefined;\n        this.entityLayerMap = undefined;\n        this.aliveEntityMap = undefined;\n        this._entity_uuid_ = 1;\n    },\n    initEntityMgr(layerMap){\n        this.entityLayerMap = layerMap;\n        this.aliveEntityMap = {};\n        this.recycleList = [];\n        this._entity_uuid_ = 1;\n        this.monsterEntityNum = 0;\n    },\n    unInitEntityMgr(){\n        this.poolMgr.destroy();\n        this.recycleList = [];\n        this.entityLayerMap = undefined;\n        this.aliveEntityMap = {};\n        this._entity_uuid_ = 1;\n    },\n    createEntity(entityType,x,y,...args){\n        var entity = this.poolMgr.get(entityType);\n        if(this.aliveEntityMap[entity._entity_uuid_]){\n            cc.error(\"EntityMgr:createEntity entity is already active\");\n            return;\n        }else{\n            this.aliveEntityMap[entity._entity_uuid_] = entity;\n        }\n\n        entity.parent = this.entityLayerMap[this.allEntityType[entityType].layer];\n        entity.active = true;\n        entity.initEntity(...args);\n        entity.x = x;\n        entity.y = y;\n\n        return entity;\n    },\n    createEntityNotInLayer(entityType,...args){\n        var entity = this.poolMgr.get(entityType);\n\n        if(this.aliveEntityMap[entity._entity_uuid_]){\n            cc.error(\"EntityMgr:createEntity entity is already active\");\n            return;\n        }else{\n            this.aliveEntityMap[entity._entity_uuid_] = entity;\n        }\n\n        entity.active = true;\n        entity.initEntity(...args);\n        return entity;\n    },\n    clearEntityByType(entityType){\n        var useList = this.poolMgr.getUse(entityType);\n        for(var key in useList){\n            var entity = useList[key];\n            if(entity){\n                this.clearEntity(entity);\n            }\n        }\n    },\n    clearEntity(entity){\n        if(!entity.active)return;\n        this.recycleList.push(entity);\n        entity.unInitEntity();\n        entity.removeFromParent();\n        entity.active = false;\n    },\n    logicUpdate(dt){\n        this.monsterEntityNum = 0;\n        for(var key in this.aliveEntityMap){\n            var entity = this.aliveEntityMap[key];\n            if(!entity)continue;\n            if(entity.logicUpdate&&entity.active){\n                entity.logicUpdate(dt);\n            }\n            if(entity.active && entity.entityType == \"EntityMonster\"){\n                this.monsterEntityNum ++ ;\n            }\n        }\n        for(var i=0;i<this.recycleList.length;i++){\n            var entity = this.recycleList[i];\n            delete this.aliveEntityMap[entity._entity_uuid_];\n            this.poolMgr.push(entity.entityType,entity);\n        }\n        this.recycleList = [];\n    },\n    getMonsterNum(){\n        return this.monsterEntityNum;\n    },\n    getNearEntity(entity,targetEntityType){\n        var findTarget = undefined;\n        var findDis = undefined;\n        for(var key in this.aliveEntityMap){\n            var target = this.aliveEntityMap[key];\n            if(target.isAlive()&&target.entityType == targetEntityType){\n                var nowDis = cc.utils.dis2(entity,target);\n                if(!findTarget||findDis>nowDis){\n                    findTarget = target;\n                    findDis = nowDis;\n                }\n            }\n        }\n        return findTarget;\n    }\n});"]}
{"version":3,"sources":["../../../../../assets/scripts/component/assets/scripts/component/ReuseItem.js"],"names":["cc","Class","extends","Component","properties","tpl","default","undefined","type","Node","maxColNum","Integer","maxRowNum","intervalCol","intervalRow","referenceNode","content","onLoad","anchorX","anchorY","x","y","Pool","require","itemPool","setBuildFunc","parent","itemNode","instantiate","bind","setResetFunc","row","col","pushNoUseFlag","scrollView","node","getComponent","ScrollView","showMap","w","width","h","height","worldTlPos","convertToWorldSpaceAR","v2","worldBrPos","error","dataLen","setDataLen","setUpdateItemFunc","updateItemFunc","updateItem","idx","item","update","itemsChange","isScrolling","isAutoScrolling","totalRow","totalCol","reset","tlPos","convertToNodeSpaceAR","brPos","deleteArr","key","push","checkNeedShow","Math","floor","getPos","getRowCol","posX","posY","tlGrid","brGrid","get","pos"],"mappings":"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","file":"ReuseItem.js","sourceRoot":"../../../../../assets/scripts/component","sourcesContent":["cc.Class({\n    extends:cc.Component,\n    properties:{\n        //item模板\n        tpl:{\n            default:undefined,\n            type:cc.Node,\n        },\n        //允许最大列数，0为不限制\n        maxColNum:{\n            default:1,\n            type:cc.Integer,\n        },\n        //允许最大行数，0为不限制\n        maxRowNum:{\n            default:0,\n            type:cc.Integer,\n        },\n        //列间隔\n        intervalCol:{\n            default:0,\n            type:cc.Integer,\n        },\n        //行间隔\n        intervalRow:{\n            default:0,\n            type:cc.Integer,\n        },\n        //遮罩节点，根据这个节点计算item的删除与显示\n        referenceNode:{\n            default: undefined,\n            type: cc.Node,\n        },\n        //item的父容器\n        content:{\n            default:undefined,\n            type:cc.Node,\n        }\n    },\n    onLoad(){\n        this.tpl.anchorX = 0.5;\n        this.tpl.anchorY = 0.5;\n        this.content.anchorX = 0;\n        this.content.anchorY = 1;\n        this.referenceNode.anchorX = 0;\n        this.referenceNode.anchorY = 1;\n        this.content.x = 0;\n        this.content.y = 0;\n\n        var Pool = require(\"Pool\");\n        this.itemPool = new Pool();\n        this.itemPool.setBuildFunc(function(parent){\n            var itemNode = cc.instantiate(this.tpl);\n            itemNode.parent = this.tpl.parent;\n            return itemNode;\n        }.bind(this));\n        this.itemPool.setResetFunc(function(itemNode){\n            itemNode.x = -10000;\n            itemNode.y = -10000;\n            itemNode.row = undefined;\n            itemNode.col = undefined;\n        }.bind(this));\n        this.itemPool.pushNoUseFlag(this.tpl);\n        this.scrollView = this.node.getComponent(cc.ScrollView);\n\n        this.showMap = {}\n\n        /*\n        0 1 \n        3 2\n        */\n        var w = this.referenceNode.width;\n        var h = this.referenceNode.height;\n        //AR表示传入的点以node的anchor point为参考系，不带AR，以左下角0，0的位置，也就是opengl\n        //的原点为参考系，返回的如果是世界坐标，那么总是opengl坐标系\n        //this.worldTlPos = this.referenceNode.convertToWorldSpace(cc.v2(0,0));\n        //this.worldBrPos = this.referenceNode.convertToWorldSpace(cc.v2(w,-h));\n        this.worldTlPos = this.referenceNode.convertToWorldSpaceAR(cc.v2(0,0));\n        this.worldBrPos = this.referenceNode.convertToWorldSpaceAR(cc.v2(w,-h));\n\n        //<=0表不限制数量\n        if((this.maxColNum==0&&this.maxRowNum==0)||(this.maxColNum>0&&this.maxRowNum>0)){\n            cc.error(\"ReuseItem colNum or RowNum is unlegal\",this.maxColNum,this.maxRowNum);\n            cc.error(\"ReuseItem colNum or RowNum must has one but only has one ==0\");\n            return;\n        }\n\n        if(this.dataLen==undefined){\n            this.setDataLen(0);\n        }\n    },\n    //初始时调用，设置item更新回调\n    setUpdateItemFunc(updateItemFunc){\n        this.updateItemFunc = updateItemFunc;\n    },\n    //由外部调用，当某个item更新的时候\n    updateItem(idx){\n        var item = this.showMap[idx];\n        if(item){\n            this.updateItemFunc(item,idx);\n        }\n    },\n    update(){\n        if(!this.itemsChange&&!this.scrollView.isScrolling()&&\n            !this.scrollView.isAutoScrolling()){\n            return;\n        }\n\n        if(this.totalRow==0&&this.totalCol==0){\n            this.itemPool.reset();\n            this.showMap = {};\n            this.itemsChange = false;\n            return;\n        }\n\n        if(this.itemsChange){\n            this.itemPool.reset();\n            this.showMap = {};\n        }\n\n        var tlPos = this.content.convertToNodeSpaceAR(this.worldTlPos);\n        var brPos = this.content.convertToNodeSpaceAR(this.worldBrPos);\n        var deleteArr = [];\n        for(var key in this.showMap){\n            var item = this.showMap[key];\n            if(!item)continue;\n\n            if(item.x<tlPos.x||item.x>brPos.x||\n               item.y>tlPos.y||item.y<brPos.y){\n                deleteArr.push(key);\n                this.itemPool.push(item);\n            }\n        }\n        for(var key in deleteArr){\n            delete this.showMap[deleteArr[key]];\n        }\n\n        this.checkNeedShow(tlPos,brPos);\n        this.itemsChange = false;\n    },\n\n    //////////////////////////////////////////////////////////////////\n    // 以下方法在item位置，尺寸，不规则时，需要重写\n    //////////////////////////////////////////////////////////////////\n    //如果每个item的大小不规则，那么由外部传入每个item的大小，在setDataLen的时候\n    //就计算好每个item的位置，供后续查询使用，现在这里只支持固定item大小\n    setDataLen(dataLen){\n        if(this.dataLen==dataLen){\n            this.itemsChange = true;\n            return;\n        }\n        this.dataLen = dataLen;\n\n        if(this.dataLen>0){\n            //列数不限制的时候，默认只有一行，不考虑多行，但列数无限的情况\n            if(this.maxColNum==0){\n                this.totalRow = 1;\n                this.totalCol = this.dataLen;\n            }else if(this.maxRowNum==0){\n                if(this.dataLen<=this.maxColNum){\n                    this.totalCol = this.dataLen;\n                    this.totalRow = 1;\n                }else{\n                    this.totalRow = Math.floor((this.dataLen-1)/this.maxColNum)+1;\n                    this.totalCol = this.maxColNum;\n                }\n            }\n        }else{\n            this.totalRow = 0;\n            this.totalCol = 0;\n        }\n        \n        this.content.width = (this.tpl.width+this.intervalCol)*this.totalCol;\n        this.content.height = (this.tpl.height+this.intervalRow)*this.totalRow;\n        this.itemsChange = true;\n    },\n    //如果不规则item大小，这里则通过查表方式获得每个item的位置，不是实时计算\n    getPos(idx){\n        var row = Math.floor(idx/this.totalCol);\n        var col = idx%this.totalCol;\n        var x = (this.tpl.width+this.intervalCol)*col+this.tpl.width*0.5;\n        var y = (this.tpl.height+this.intervalRow)*row+this.tpl.height*0.5;\n        return {x:x,y:-y};\n    },\n    //根据content中某个点的位置，换算行列，这个方法用来换算左上角，和右下角所处的行列\n    //checkNeedShow中调用此方法，检测哪些item需要重新显示出来，如果item位置不规则\n    //就不能使用这种方法来检测哪些item需要显示，必须使用item是否在可视区域内来检测\n    getRowCol(posX,posY){\n        var col = Math.floor(posX/(this.tpl.width+this.intervalCol));\n        var row = Math.floor(-posY/(this.tpl.height+this.intervalRow));\n        if(col>=this.totalCol){\n            col=this.totalCol-1;\n        }\n        if(col<0){\n            col = 0;\n        }\n        if(row>=this.totalRow){\n            row=this.totalRow-1;\n        }\n        if(row<0){\n            row=0;\n        }\n        return {row:row,col:col};\n    },\n    checkNeedShow(tlPos,brPos){\n        var tlGrid = this.getRowCol(tlPos.x,tlPos.y);\n        var brGrid = this.getRowCol(brPos.x,brPos.y);\n        for(var row=tlGrid.row;row<=brGrid.row;row++){\n            for(var col=tlGrid.col;col<=brGrid.col;col++){\n                var idx = col+row*this.totalCol;\n                if(idx>=this.dataLen)continue;\n                if(!this.showMap[idx]){\n                    var item = this.itemPool.get();\n                    item.idx = idx;\n                    var pos = this.getPos(idx);\n                    item.x = pos.x;\n                    item.y = pos.y;\n                    if(this.updateItemFunc){\n                        this.updateItemFunc(item,idx);\n                    }\n                    this.showMap[idx] = item;\n                }\n            }\n        }\n    },\n})"]}
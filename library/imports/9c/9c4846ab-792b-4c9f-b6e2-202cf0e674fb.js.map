{"version":3,"sources":["../../../../../../assets/scripts/node/entity/assets/scripts/node/entity/EntityBase.js"],"names":["ColliderCallback","cc","Class","extends","Component","onCollisionEnter","other","self","node","_onCollisionEnter","onCollisionStay","_onCollisionStay","onCollisionExit","_onCollisionExit","EntityBase","Node","ctor","gameui","resMgr","getRes","resName","editorui","commonui","bulletui","addComponent","curSceneName","touchNode","setContentSize","parent","myType","undefined","myIdx","myProperty","myPropertyArr","propValue","rowValue","colliderObjArr","colliderInfoStr","isAlive","active","_keyHandle","event","moveHelp","keyObj","detail","keyHandle","keyCode","KEY","Delete","entityMgr","clearEntity","initGameData","gameData","preState","entityState","unknow","state","initEntity","globalEvent","on","_updateProperty","SystemEvent","EventType","KEY_UP","mouseUpHandle","unInitEntity","off","unSelect","_onPreDestroy","_super","type","idx","judgeProperty","property","updateProperty","indexOf","enableCollider","val","key","colliderObj","enabled","initColliderArr","JSON","stringify","colliderArr","isPreEnable","destroy","colliderInfo","utils","newCCObj","push","listValue","configData","getConfigList","getProperty","error","x","y","select","emit","instantiate","moveComp","getComponent","require","setMoveHandle","hasOwnProperty","editData","modifyField","bind","editRow","setState","getState","module","exports"],"mappings":"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","file":"EntityBase.js","sourceRoot":"../../../../../../assets/scripts/node/entity","sourcesContent":["var ColliderCallback = cc.Class({\n    extends:cc.Component,\n\n    onCollisionEnter: function (other, self) {\n        this.node._onCollisionEnter(other,self);\n    },\n      \n    onCollisionStay: function (other, self) {\n        this.node._onCollisionStay(other,self);\n    },\n    \n    onCollisionExit: function (other, self) {\n        this.node._onCollisionExit(other,self);\n    }\n});\n\nvar EntityBase = cc.Class({\n    extends:cc.Node,\n    _onCollisionEnter(other,self){},\n    _onCollisionStay(other,self){},\n    _onCollisionExit(other,self){},\n    ctor(){\n        this.gameui = cc.resMgr.getRes(cc.resName.gameui);\n        this.editorui = cc.resMgr.getRes(cc.resName.editorui);\n        this.commonui = cc.resMgr.getRes(cc.resName.commonui);\n        this.bulletui = cc.resMgr.getRes(cc.resName.bulletui);\n        this.addComponent(ColliderCallback);\n\n        if(cc.resMgr.curSceneName == 'editor'){\n            this.touchNode = new cc.Node();\n            this.touchNode.setContentSize(70,70);\n            this.touchNode.parent = this;\n        }\n\n        this.myType = undefined;\n        this.myIdx = undefined;\n        this.myProperty = undefined;\n        this.myPropertyArr = undefined;\n        this.propValue = undefined;\n        this.rowValue = undefined;\n        this.colliderObjArr = [];\n        this.colliderInfoStr = undefined;\n        \n    },\n    isAlive(){\n        return this.active;\n    },\n    _keyHandle(event){\n        if(!this.moveHelp)return;\n        var keyObj = event.detail;\n        this.keyHandle(keyObj.keyCode);\n    },\n    keyHandle(keyCode){\n        switch(keyCode) {\n            case cc.KEY.Delete:\n                cc.entityMgr.clearEntity(this);\n                break;\n        }\n    },\n    initGameData(){\n        this.gameData = {\n            preState : cc.entityState.unknow,\n            state : cc.entityState.unknow\n        };\n    },\n    initEntity(...args){\n        cc.globalEvent.on(\"EditData:updateList\",this._updateProperty,this);\n        cc.globalEvent.on(cc.SystemEvent.EventType.KEY_UP,this._keyHandle,this);\n        if(cc.resMgr.curSceneName == 'editor'){\n            this.touchNode.on('touchend',this.mouseUpHandle,this);\n        }\n        this.initGameData();\n    },\n    unInitEntity(){\n        if(this.touchNode){\n            this.touchNode.off('touchend',this.mouseUpHandle,this);\n        }\n        cc.globalEvent.off(\"EditData:updateList\",this._updateProperty,this);\n        cc.globalEvent.off(cc.SystemEvent.EventType.KEY_UP,this._keyHandle,this);\n        cc.globalEvent.off(\"Entity:unSelect\",this.unSelect,this);\n        this.unSelect();\n    },\n    _onPreDestroy(){\n        this._super();\n    },\n    _updateProperty(event){\n        var detail = event.detail;\n        if(detail.type && detail.type != this.myType){\n            return false;\n        }\n        if(detail.idx && detail.idx != this.myIdx){\n            return false;\n        }\n        if(!this.judgeProperty(detail.property)){\n            return false;\n        }\n        this.updateProperty(detail.property);\n    },\n    judgeProperty(property){\n        if(property&&this.myProperty){\n            if(property.indexOf(this.myProperty)==-1&&\n              this.myProperty.indexOf(property)==-1)return false;\n        }\n        return true;\n    },\n    enableCollider(val){\n        for(var key in this.colliderObjArr){\n            var colliderObj = this.colliderObjArr[key];\n            if(colliderObj){\n                colliderObj.enabled = val;\n            }\n        }\n    },\n    initColliderArr(){\n        var colliderInfoStr = JSON.stringify(this.propValue.colliderArr);\n        if(colliderInfoStr == this.colliderInfoStr)return;\n        this.colliderInfoStr = colliderInfoStr;\n\n        var isPreEnable = undefined;\n        for(var key in this.colliderObjArr){\n            var colliderObj = this.colliderObjArr[key];\n            if(!colliderObj)continue;\n            isPreEnable = colliderObj.active;\n            colliderObj.destroy();\n        }\n        this.colliderObjArr = [];\n\n        for(var key in this.propValue.colliderArr){\n            var colliderInfo = this.propValue.colliderArr[key];\n            if(!colliderInfo)continue;\n            var colliderObj = cc.utils.newCCObj(colliderInfo,this);\n            colliderObj.active = isPreEnable;\n            this.colliderObjArr.push(colliderObj);\n        }\n    },\n    updateProperty(property){\n        if(!this.myType)return false;\n\n        if(!property){\n            this.listValue = cc.configData.getConfigList(this.myType);\n            this.rowValue = this.listValue[this.myIdx];\n            if(!this.rowValue)return false;\n            if(this.myPropertyArr){\n                this.propValue = cc.utils.getProperty(this.rowValue,...this.myPropertyArr);\n                if(!this.propValue){\n                    cc.error(\"EntityBase:updateProperty propValue is undefined\",this.myType,\n                    this.myIdx,this.myProperty);\n                    return false;\n                }\n            }else{\n                this.propValue = this.rowValue;\n            }\n        }\n\n        if(this.propValue.colliderArr){\n            this.initColliderArr();\n        }\n\n        this.x = this.propValue.x || this.x;\n        this.y = this.propValue.y || this.y;\n\n        //只更新xy坐标，其余操作没必要继续\n        if(property&&(property.indexOf(\"@x\")!=-1||property.indexOf(\"@y\")!=-1)){\n            return false;\n        }\n        return true;\n    },\n    mouseUpHandle(event){\n        cc.globalEvent.off(\"Entity:unSelect\",this.unSelect,this);\n        this.select();\n    },\n    select(){\n        cc.globalEvent.emit(\"Entity:unSelect\");\n        this.moveHelp = cc.instantiate(cc.resMgr.getRes(cc.resName.moveHelp));\n        this.moveHelp.parent = this;\n\n        var moveComp = this.moveHelp.getComponent(require(\"Move\"));\n        moveComp.setMoveHandle(function(){\n            if(!this.propValue||!this.propValue.hasOwnProperty(\"x\")){\n                return;\n            }\n            this.propValue.x = this.x;\n            this.propValue.y = this.y;\n            cc.editData.modifyField(this.myType,this.myIdx,this.myProperty+\"@x\",this.x);\n            cc.editData.modifyField(this.myType,this.myIdx,this.myProperty+\"@y\",this.y);\n        }.bind(this));\n        cc.editData.editRow(this.myType,this.myIdx);\n        cc.globalEvent.on(\"Entity:unSelect\",this.unSelect,this);\n    },\n    unSelect(){\n        if(this.moveHelp){\n            this.moveHelp.destroy();\n            this.moveHelp = undefined;\n        }\n    },\n    setState(state){\n        this.gameData.preState = this.gameData.state;\n        this.gameData.state = state;\n    },\n    getState(){\n        return this.gameData.state;\n    },\n});\n\nmodule.exports = EntityBase;"]}
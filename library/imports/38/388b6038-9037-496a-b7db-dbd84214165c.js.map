{"version":3,"sources":["../../../../../../../assets/scripts/node/entity/tower/assets/scripts/node/entity/tower/TowerDirBase.js"],"names":["cc","Class","extends","require","ctor","group","initDir","v2","xDir","initEntity","_super","initGameData","gameData","targetQueue","curTarget","undefined","pickingTarget","goTime","rotateTime","configData","towerAll","bulletInfo","launchInfoDirty","unWork","unLaunchBullet","launchBullet","getLaunchInfo","worldPos","baseNode","convertToWorldSpaceAR","propValue","bullet","x","y","bulletPos","parent","convertToNodeSpaceAR","worldDirPos","worldBasePos","Vec2","ZERO","worldDir","bulletAng","signAngle","pos","ang","_onCollisionEnter","other","self","push","node","updateProperty","property","changeTargetFinished","pickTarget","length","target","nextDir","angle","utils","getDirAng","action","sequence","rotateTo","callFunc","runAction","followTarget","Math","abs","rotation","logicUpdate","dt","isAlive","removeTarget","launchInterval","removeNode","idx","splice","_onCollisionExit"],"mappings":"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","file":"TowerDirBase.js","sourceRoot":"../../../../../../../assets/scripts/node/entity/tower","sourcesContent":["cc.Class({\n    extends:require(\"TowerBase\"),\n    ctor(){\n        this.group = \"tower\";\n        this.initDir = cc.v2(0,-1);\n        this.xDir = cc.v2(1,0);\n    },\n    initEntity(...args){\n        this._super(...args);\n    },\n    initGameData(){\n        this._super();\n\n        this.gameData.targetQueue = [];\n        this.gameData.curTarget = undefined;\n        this.gameData.pickingTarget = false;\n        this.gameData.goTime = undefined;\n        this.gameData.rotateTime = cc.configData.towerAll.rotateTime;\n        this.gameData.bulletInfo = undefined;\n        this.gameData.launchInfoDirty = true;\n    },\n    unWork(){\n        this._super();\n        this.gameData.targetQueue = [];\n        this.gameData.curTarget = undefined;\n        this.gameData.pickingTarget = false;\n        this.gameData.goTime = undefined;\n        this.gameData.bulletInfo = undefined;\n        this.gameData.launchInfoDirty = true;\n        this.unLaunchBullet();\n    },\n    launchBullet(){\n        \n    },\n    unLaunchBullet(){\n\n    },\n    getLaunchInfo(){\n        if(this.gameData.launchInfoDirty){\n            var worldPos = this.baseNode.convertToWorldSpaceAR(\n                cc.v2(this.propValue.bullet.x,this.propValue.bullet.y));\n            var bulletPos = this.parent.convertToNodeSpaceAR(worldPos);\n            //武器的方向，就是子弹的方向，把武器的本地方向转换成世界方向，就可以给子弹使用\n            var worldDirPos = this.baseNode.convertToWorldSpaceAR(this.initDir);\n            var worldBasePos = this.baseNode.convertToWorldSpaceAR(cc.Vec2.ZERO);\n            var worldDir = cc.v2(worldDirPos.x-worldBasePos.x,worldDirPos.y-worldBasePos.y);\n            var bulletAng = worldDir.signAngle(this.xDir);\n            this.gameData.bulletInfo = {pos:bulletPos,ang:bulletAng};\n        }\n        return this.gameData.bulletInfo;\n    },\n    _onCollisionEnter(other,self){\n        this.gameData.targetQueue.push(other.node);\n    },\n    updateProperty(property){\n        if(!this._super(property)){\n            return false;\n        }\n\n        this.gameData.rotateTime = cc.configData.towerAll.rotateTime;\n        this.gameData.launchInfoDirty = true;\n\n        return true;\n    },\n    changeTargetFinished(){\n\n    },\n    pickTarget(){\n        if(this.gameData.pickingTarget){\n            return;\n        }\n        if(this.gameData.targetQueue.length==0)return;\n        this.gameData.pickingTarget = true;\n        var target = this.gameData.targetQueue[0];\n        var nextDir = cc.v2(target.x-this.x,target.y-this.y);\n        var angle = cc.utils.getDirAng(this.x,this.y,this.initDir,target.x,target.y);\n        var action = cc.sequence(\n            cc.rotateTo(this.gameData.rotateTime,angle),\n            cc.callFunc(function(){\n                this.gameData.pickingTarget = false;\n                this.gameData.curTarget = target;\n                this.gameData.goTime = undefined;\n                this.gameData.launchInfoDirty = true;\n                this.changeTargetFinished();\n            },this));\n        this.baseNode.runAction(action);\n    },\n    followTarget(target){\n        var angle = cc.utils.getDirAng(this.x,this.y,this.initDir,target.x,target.y);\n        if(Math.abs(this.baseNode.rotation - angle)<=0.001){\n            return;\n        }\n        this.baseNode.rotation = angle;\n        this.gameData.launchInfoDirty = true;\n    },\n    logicUpdate(dt){\n        if(!this._super(dt)){\n            return false;\n        }\n        if(this.gameData.curTarget&&!this.gameData.curTarget.isAlive()){\n            this.removeTarget(this.gameData.curTarget);\n            this.gameData.curTarget = undefined;\n        }\n        if(!this.gameData.curTarget){\n            this.unLaunchBullet();\n            if(!this.gameData.pickingTarget){\n                this.pickTarget();\n            }\n            return;\n        }\n        this.followTarget(this.gameData.curTarget);\n        if(this.propValue.launchInterval){\n            if(this.gameData.goTime!=undefined&&\n               this.gameData.goTime<this.propValue.launchInterval){\n                this.gameData.goTime+=dt;\n                return;\n            }\n            this.gameData.goTime=0;\n            this.launchBullet();\n        }else{\n            this.launchBullet();\n        }\n    },\n    removeTarget(removeNode){\n        for(var idx=0;idx<this.gameData.targetQueue.length;idx++){\n            var target = this.gameData.targetQueue[idx];\n            if(target === removeNode){\n                this.gameData.targetQueue.splice(idx,1);\n                if(target == this.gameData.curTarget){\n                    this.gameData.curTarget = undefined;\n                }\n                break;\n            }\n        }\n    },\n    _onCollisionExit(other,self){\n        this.removeTarget(other.node);\n        if(other.node === this.gameData.curTarget){\n            this.gameData.curTarget = undefined;\n        }\n    },\n});"]}
{"version":3,"sources":["../../../../../../../assets/scripts/node/entity/tower/assets/scripts/node/entity/tower/TowerBomb.js"],"names":["cc","Class","extends","require","ctor","initDir","v2","xDir","initGameData","_super","gameData","buildBombTime","curBombNum","prepareToLaunch","initEntity","idx","floorIdx","resMgr","curSceneName","globalEvent","on","touchendLayer","touchhoverLayer","unInitEntity","off","logicUpdate","dt","propValue","maxBombNum","event","touchInfo","detail","touchPos","mousePos","angle","utils","getDirAng","x","y","baseNode","rotation","touchstartTower","canWork","stopPropagation","touchEvent","handleDis2","dis2","handleRadius","tip","targetDir","launchAng","signAngle","dis","pDistance","entityMgr","createEntity","myIdx"],"mappings":"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","file":"TowerBomb.js","sourceRoot":"../../../../../../../assets/scripts/node/entity/tower","sourcesContent":["cc.Class({\n    extends:require(\"TowerBase\"),\n    ctor(){\n        this.initDir = cc.v2(0,-1);\n        this.xDir = cc.v2(1,0);\n    },\n    initGameData(){\n        this._super();\n        this.gameData.buildBombTime = 0;\n        this.gameData.curBombNum = 0;\n        this.gameData.prepareToLaunch = false;\n    },\n    initEntity(idx,floorIdx){\n        this._super(idx,floorIdx);\n        if(cc.resMgr.curSceneName != 'editor'){\n            cc.globalEvent.on(\"GameTouch:touchend\",this.touchendLayer,this);\n            cc.globalEvent.on(\"GameTouch:touchleave\",this.touchendLayer,this);\n            cc.globalEvent.on(\"GameTouch:touchhover\",this.touchhoverLayer,this);\n        }\n    },\n    unInitEntity(){\n        this._super();\n        this.gameData.prepareToLaunch = false;\n        if(cc.resMgr.curSceneName != 'editor'){\n            cc.globalEvent.off(\"GameTouch:touchend\",this.touchendLayer,this);\n            cc.globalEvent.off(\"GameTouch:touchleave\",this.touchendLayer,this);\n            cc.globalEvent.off(\"GameTouch:touchhover\",this.touchhoverLayer,this);\n        }\n    },\n    logicUpdate(dt){\n        if(!this._super(dt)){\n            return false;\n        }\n        if(this.gameData.curBombNum<this.propValue.maxBombNum){\n            this.gameData.buildBombTime+=dt;\n            if(this.gameData.buildBombTime>this.propValue.buildBombTime){\n                this.gameData.buildBombTime = 0;\n                this.gameData.curBombNum++;\n            }\n        }else{\n            this.gameData.buildBombTime = 0;\n        }\n    },\n    touchhoverLayer(event){\n        if(!this.gameData.prepareToLaunch)\n            return;\n        var touchInfo = event.detail;\n        var touchPos = touchInfo.mousePos;\n        var angle = cc.utils.getDirAng(this.x,this.y,this.initDir,touchPos.x,touchPos.y);\n        this.baseNode.rotation = angle;\n    },\n    touchstartTower(event){\n        this._super(event);\n        if(!this.canWork()){\n            return;\n        }\n        if(this.gameData.curBombNum==0){\n            return;\n        }\n        this.gameData.prepareToLaunch = true;\n        //当地图可拖拽时，点击炸弹塔，不让地图拖拽\n        event.stopPropagation();\n    },\n    touchendLayer(event){\n        var touchInfo = event.detail;\n        var touchPos = touchInfo.mousePos;\n        var touchEvent = touchInfo.event;\n        if(!this.gameData.prepareToLaunch)return;\n        this.gameData.prepareToLaunch = false;\n        var handleDis2 = cc.utils.dis2(touchPos,this);\n        var handleRadius = this.propValue.handleRadius;\n        if(handleDis2>handleRadius*handleRadius){\n            cc.utils.tip(\"too far away from the bomb tower\");\n            return;\n        }\n        this.gameData.curBombNum--;\n\n        var targetDir = cc.v2(touchPos.x-this.x,touchPos.y-this.y);\n        var launchAng = targetDir.signAngle(this.xDir);\n        var dis = cc.pDistance(this,touchPos);\n        cc.entityMgr.createEntity(\"BulletBomb\",\n        this.x,\n        this.y,\n        this.myIdx,\n        touchPos,launchAng,dis);\n    },\n});"]}